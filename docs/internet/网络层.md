# 网络层

## 网络层提供的两种服务
在计算机网络领域，网络层应该向运输层提供怎样的服务（“面向连接”还是“无连接”）曾引起了长期的争论。
争论焦点的实质就是：在计算机通信中，可靠交付应当由谁来负责？是**网络**还是**端系统**？ 

在计算机通信中，可靠交付由**端系统**负责！

### 虚电路服务

+ 虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
+ 请注意，电路交换的电话通信是先建立了一条真正的连接。
+ 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样

![虚电路服务](/internet/4-1.png "虚电路服务")
 
### 数据报服务

+ 网络层向上只提供简单灵活的、无连接的、**尽最大努力交付**的数据报服务。
+ 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
+ 网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

![耳机分割线](/line1.png "耳机分割线")

**尽最大努力交付的好处**：
+ 由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。
+ 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责可靠交付（包括差错处理、流量控制等） 。
+ 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。
+ 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。 

![数据报服务](/internet/4-2.png "数据报服务")

### 虚电路服务和数据报服务对比

| 对比的方面| 虚电路服务| 数据报服务|
|---------------|-------------------------|---------------------------|
| 思路| 可靠通信应当由网络来保证| 可靠通信应当由用户主机来保证|
| 连接的建立| 必须有| 不需要|
| 终点地址| 仅在连接建立阶段使用，每个分组使用短的虚电路号| 每个分组都都有终点的完整地址|
| 分组的转发| 属于同一条虚电路的分组均按照同一路由进行转发| 每个分组独立选择路由进行转发|
| 当结点出现故障时| 所有通过出故障的结点的虚电路均不能工作| 出故障的结点可能会丢失分组，一些路由可能会发生变化 |
| 分组的顺序| 总是按发送顺序到达终点| 到达终点的时间不一定按发送顺序|
| 端到端的查错处理和流量控制 | 可以由网络负责，也可以由用户主机负责| 由用户主机负责|

## 网际协议 IP
网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一，也是最重要的互联网标准协议之一。 
与 IP 协议配套使用的还有三个协议：
+ **地址解析协议 ARP (Address Resolution Protocol)**
+ **网际控制报文协议 ICMP (Internet Control Message Protocol)**
+ **网际组管理协议 IGMP (Internet Group Management Protocol)**

本来还有一个协议叫做逆地址解析协议 RARP (Reverse Address Resolution Protocol)，是和 ARP协议配合使用的。但现在已经被淘汰不用了。

![网际协议](/internet/4-3.png "网际协议")

### 虚拟互连网络

网络互连的设备：
+ 物理层中间系统：转发器（中继器） (repeater)。
+ 数据链路层中间系统：网桥 或 桥接器 (bridge)、交换机。
+ 网络层中继系统：路由器 (router)。
+ 网桥和路由器的混合物：桥路器 (brouter)。
+ 网络层以上的中间系统：网关 (gateway)。

补充：
+ 当中继系统是转发器或网桥时，一般并**不称之为网络互连**，因为这仅仅是**把一个网络扩大了**，而这仍然是一个网络。 
+ 网关由于比较复杂，目前使用得较少。
+ **网络互连都是指用路由器进行网络互连和路由选择**。
+ 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。   

#### 互连网络和虚拟互连网络
+ 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。
+ 使用 IP 协议的虚拟互连网络可简称为 IP 网。
+ 使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。
+ 如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)。

![IP网的概念](/internet/4-4.png "IP网的概念")
![耳机分割线](/line1.png "耳机分割线")
![分组在互联网中的传送](/internet/4-5.png "分组在互联网中的传送")

## IP 地址
我们把整个互联网看成为一个单一的、抽象的网络。IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在**全世界范围是唯一的 32 位的标识符**。IP 地址现在由互联网名字和数字分配机构ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。 

IP 地址的编址方法：
+ **分类的 IP 地址**。这是最基本的编址方法，在1981年就通过了相应的标准协议。
+ **子网的划分**。这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。
+ **构成超网**。这是比较新的无分类编址方法。1993年提出后很快就得到推广应用。

### 分类的 IP 地址
+ 将IP地址划分为若干个固定类。
+ 每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。
+ 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
+ 由此可见，一个 IP 地址在整个互联网范围内是唯一的。

这种两级的 IP 地址可以记为：

$$IP 地\_址\_ ::= \{ <网\_络\_号\_>, <主\_机\_号\_> \}$$

![分类的IP地址](/internet/4-6.png "分类的IP地址")

+ A 类、B 类和 C 类地址的网络号段分别为 1 个、2 个和 3 个字节长，而在网络号字段的最前面有 1~3 位的**类别位**，其数字分别规定为 0，10 和 110。
+ A 类、B 类和 C 类地址的主机号字段分别为 3 个、2 个、和 1 个字节长。
+ D 类地址（前 4 位是 1110）用于**多播**。
+ E 类地址（前 4 位是 1111）保留为以后使用。

对于主机或路由器来说，IP 地址都是 32 位 的二进制代码。为了提高可读性，我们常常把 32 位的 IP 地址中的每 8 位插入一个空格。为了便于书写，可用其等效的十进制数字表示，并且在这些数字之间加上一个点。这就叫做**点分十进制记法(dotted decimal notation)**
![点分十进制记法](/internet/4-7.png "点分十进制记法")

IP 地址的指派范围

+ A 类地址的网络号字段占一个字节，只有 7 位可以提供使用，但可指派的网络号是 126($2^7 - 2$) 个。减 2 的原因是：第一，IP 地址中的全 0 表示“**这个(this)**”。网络号字段全 0 的 IP 地址是个保留地址，意思是**本网络**；第二网络号为 127 保留为本地软件环回测试本主机进程之间的通信之用。
+ A 类地址的主机号占 3 个自己，因此每一个 A 类网络中的最大主机数是 $2^{24} - 2$，即 16777214。减 2 的原因是：全 0 的主机号字段表示该 IP 地址就是本主机所连接到的**单个网络地址**，因此全 1 的主机号字段表示该网络上的所有主机。
+ B 类网络地址 128.0.0.0 是不指派的。因此 B 类地址可指派的网络数为 $2^{14} - 1$ 。B 类地址的每个网络上的最大主机数为 $2^{16} - 2$，减 2 的原因是要扣除全 0 和全 1 的主机号。
+ C 类网络地址 192.0.0.0也是不知指派的，因此 C 类地址可指派的网络总数是 $2^{21} - 1$，每个 C 类地址的最大主机数是 $2^8 - 2$。

这样，就有了下表所示的 IP 地址的指派范围：

| 网络类别 | 最大可指派的网络数               | 第一个可指派的网络号 | 最后一个指派的网络号    | 每个网络中的最大主机数         |
|:----:|:-----------------------:|:----------:|:-------------:|:-------------------:|
| A    | 126($2^7 - 2$)          | 1          | 126           | 16777214 ($2^{24} - 2$) |
| B    | 16383($2^{14} - 1$)     | 128.1      | 191.255       | 65534 ($2^{16} - 2$)    |
| C    | 2097151($2^{21} - 1$)   | 192.0.1    | 223.255.255   | 254 ($2^8 - 2$)         |

一般不适用的特殊 IP 地址

| 网络号   | 主机号| 源地址使用 | 目的地址使用 | 代表的意思|
|---------|----------------|-------|--------|----------------------|
| 0       | 0              | 可以    | 不可     | 在本网络上的本主机|
| 0       | host-id        | 可以    | 不可     | 在本网络上的某台主机 host-id|
| 全 1    | 全 1            | 不可    | 可以     | 只在本网络上进行广播（各路由器均不转发）|
| net-id  | 全 1            | 不可    | 可以     | 对 net-id 上的所有主机进行广播|
| 127     | 非全 0 或全 1 的任何数 | 可以    | 可以     | 用于本地软件换回测试|

### IP 地址的一些重要特点
1. **IP 地址是一种分等级的地址结构**。分两个等级的好处是：
    + 第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
    + 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存空间。 
2. **实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口**。
    + 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机 (multihomed host)。
    + 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址。 
3. **用转发器或网桥连接起来的若干个局域网仍为一个网络**，因此这些局域网都具有同样的网络号 net-id。
4. 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是**平等**的。



## 划分子网和构造超网

## 网际控制报文协议 ICMP

## 互联网的路由选择协议

## IPv6

## IP 多播

## 虚拟专用网 VPN 和网络地址转换 NAT

## 多协议标记就换 MPLS
