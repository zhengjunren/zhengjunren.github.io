# 数据链路层

## 使用点对点信道的数据链路层

### 数据链路和帧
+ **链路** (link) 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。
    + 一条链路只是一条通路的一个组成部分

+ **数据链路** (data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。
    + 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。
    + 一般的适配器都包括了数据链路层和物理层这两层的功能。 

也有人采用另外的术语。这就是把链路分为**物理链路**和**逻辑链路**。
物理链路就是上面所说的链路。逻辑链路就是上面的数据链路，是物理链路加上必要的通信协议。
早期的数据**通信协议**曾叫做**通信规程** (procedure)。**因此在数据链路层，规程和协议是同义语**。

![数据链路层传输的是帧](/internet/3-2.png "数据链路层传输的是帧")

+ 常常在两个对等的数据链路层之间画出一个数字管道，而在这条数字管道上传输的数据单位是**帧**。
+ 数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。

### 三个基本问题
数据链路层协议有许多种，但有三个基本问题则是共同的： **封装成帧**、**透明传输**、**差错控制**。

1. **封装成帧**
    + **封装成帧** (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
    + 首部和尾部的一个重要作用就是进行**帧定界**。 
![封装成帧](/internet/3-3.png "封装成帧")
    + 用控制字符进行帧定界的方法举例
        + 当数据是由可打印的 ASCII 码组成的文本文件时，帧定界可以使用特殊的帧定界符。
        + 控制字符 **SOH** (Start Of Header) 放在一帧的最前面，表示帧的首部开始。另一个控制字符 **EOT** (End Of Transmission) 表示帧的结束。
![用控制字符进行帧定界的方法举例](/internet/3-4.png "用控制字符进行帧定界的方法举例用控制字符进行帧定界的方法举例")

2. **透明传输**
    + 如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”。
![透明传输](/internet/3-5.png "透明传输")
    + 解决透明传输问题
        + 解决方法：字节填充 (byte stuffing) 或字符填充 (character stuffing)。
        + 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是1B)。
        + 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
        + 如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 
![字节填充](/internet/3-6.png "字节填充")

:::tip 透明
指某一个实际存在的事物看起来却好像不存在一样。
“在数据链路层透明传送数据”表示无论发送什么样的比特组合的数据，这些数据都能够按照原样没有差错地通过这个数据链路层。
可以看看[**这篇文章**](https://blog.csdn.net/qq_40911292/article/details/89528655)
:::

3. **差错检测**
    + 在传输过程中可能会产生比特差错：1 可能会变成 0， 而 0 也可能变成 1。
![差错检测](/internet/3-7.png "差错检测")
    + 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER (Bit Error Rate)。
    + 误码率与信噪比有很大的关系。
    + 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。 
    + 在数据链路层传送的帧中，广泛使用了**循环冗余检验** CRC 的检错技术。
    + 下面的例子中，可以用$P(X) = X^3 + X^2 + 1$表示除数 P=1101(最高位对应$X^3$,最低位对应于$X^0$)。
![循环冗余检验](/internet/3-8.png "循环冗余检验")

4. **注意事项**
    + 仅用循环冗余检验 CRC 差错检测技术只能做到**无差错接受** (accept)。
    + “无差错接受”是指：“凡是接受的帧（即不包括丢弃的帧），我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错”。
    + 也就是说：“**凡是接收端数据链路层接受的帧都没有传输差错**”（有差错的帧就丢弃而不接受）。
    + 单纯使用 CRC 差错检测技术**不能实现**“无差错传输”或“可靠传输”。
    + 应当明确，“无比特差错”与“无传输差错”是不同的概念。
    + 在数据链路层使用 CRC 检验，能够实现**无比特差错**的传输，但这还不是可靠传输。
    + 要做到“无差错传输”（即发送什么就收到什么）就必须再加上确认和重传机制。 
    + 本章介绍的数据链路层协议都不是可靠传输的协议。


## 点对点协议 PPP
### PPP 协议的特点
+ 对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point Protocol)。
+ PPP 协议在 1994 年就已成为互联网的正式标准。
![用户到ISP的链路使用PPP协议](/internet/3-9.png "用户到ISP的链路使用PPP协议")
+ **PPP 协议应满足的需求**：
    + 简单：这是首要的要求。
    + 封装成帧：必须规定特殊的字符作为帧定界符。
    + 透明性：必须保证[数据传输的透明性]((https://blog.csdn.net/qq_40911292/article/details/89528655))。
    + 多种网络层协议：能够在同一条物理链路上同时支持多种网络层协议。
    + 多种类型链路：能够在多种类型的链路上运行。
    + 差错检测：能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
    + 检测连接状态：能够及时自动检测出链路是否处于正常工作状态。
    + 最大传送单元：必须对每一种类型的点对点链路设置最大传送单元  MTU 的标准默认值，促进各种实现之间的互操作性。
    + 网络层地址协商：必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。
    + 数据压缩协商：必须提供一种方法来协商使用数据压缩算法。
+ PPP 协议不需要满足的要求：纠错、流量控制、序号、多点线路、半双工或单工链路。

+ **PPP 协议的组成**：
    + 一个将 IP 数据报封装到串行链路的方法。
    + 链路控制协议 LCP (Link Control Protocol)。
    + 网络控制协议 NCP (Network Control Protocol)。 

### PPP 协议的帧格式
+ PPP 帧的首部和尾部分别为 4 个字段和 2 个字段。
+ 标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）。
+ 地址字段 A 只置为 0xFF。地址字段实际上并不起作用。
+ 控制字段 C 通常置为 0x03。
+ PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。
![协议的帧格式](/internet/3-10.png "协议的帧格式")

当 PPP 用在异步传输时，就使用一种特殊的字符填充法。
当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）

### 字节填充
+ 将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)。 
+ 若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)。
+ 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。 
![字节填充](/internet/3-11.png "字节填充")
### 零比特填充
+ PPP 协议用在 SONET/SDH 链路时，使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。
+ 在发送端，只要发现有 5 个连续 1，则立即填入一个 0。
+ 接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除。
![零比特填充](/internet/3-12.png "零比特填充")

PPP 协议之所以**不使用序号和确认机制**是出于以下的考虑：
+ 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
+ 在因特网环境下，PPP 的信息字段放入的数据是 IP  数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
+ 帧检验序列 FCS 字段可保证无差错接受。

### PPP 协议的工作状态
1. 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
2. PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
3. 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
4. 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。
![PPP协议的工作状态](/internet/3-13.png "PPP协议的工作状态")

可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容。


## 使用广播信道的数据链路层
+ 局域网最主要的特点是：
    + 网络为一个单位所拥有；
    + 地理范围和站点数目均有限。 
+ 局域网具有如下主要优点：
    + 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 
    + 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
    + 提高了系统的可靠性、可用性和残存性。
    
**局域网的拓扑结构**
![局域网的拓扑结构](/internet/3-14.png "局域网的拓扑结构")

**局域网传输媒体**
![局域网传输媒体](/internet/3-15.png "局域网传输媒体")

**局域网共享信道带来的问题**
![局域网共享信道带来的问题](/internet/3-16.png "局域网共享信道带来的问题")

### 局域网的数据链路层

### CSMA/CD 协议

### 使用集线器的星形拓扑

### 以太网的信道利用率

### 以太网的 MAC 层


## 扩展的以太网

## 高速以太网
